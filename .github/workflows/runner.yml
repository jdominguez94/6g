name: Deploy to Kubernetes

on:
  workflow_call:

jobs:
  deploy:
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Validate KUBECONFIG secret
        run: |
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "❌ Secret KUBECONFIG is not set or is empty"
            exit 1
          else
            echo "✅ Secret KUBECONFIG is set"
          fi

      - name: Set up kubeconfig
        run: |
          set -euo pipefail
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify Kubernetes connection
        run: |
          set -euo pipefail
          echo "🔍 Getting cluster nodes..."
          kubectl get nodes || (echo "❌ Failed to connect to Kubernetes cluster" && exit 1)

      - name: Apply Kubernetes manifests
        run: |
          set -euo pipefail
          echo "🚀 Applying Kubernetes manifests..."
          kubectl apply -f ./setup/runnerdeployment.yaml

      - name: Clean up kubeconfig
        if: always()
        run: rm -f $HOME/.kube/config
